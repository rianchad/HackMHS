<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Revenue</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
       <style>
        @import url('/static/css/best');
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="p-4 text-white text-center text-2xl font-bold">
        Manage Revenue
    </header>
    <main class="flex-1 flex items-start justify-center mt-10">
        <a href="home.html" class="text-blue-600 hover:underline text-base font-semibold absolute left-8 top-8">‚Üê Back to Home</a>
        <!-- Parameters Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 w-1/4 mr-6">
            <h2 class="text-xl font-semibold text-blue-700 mb-4">Parameters</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1">Starting Money ($)</label>
                <input type="number" id="moneyStarting" value="100000" min="0" step="1" class="block w-full border border-gray-300 rounded px-3 py-2 mb-2">
                <label class="block text-gray-700 mb-1">Interest Rate (%)</label>
                <input type="number" id="interestRate" value="3" min="0" max="100" step="0.01" class="block w-full border border-gray-300 rounded px-3 py-2 mb-2">
                <label class="block text-gray-700 mb-1">Loan Term (days)</label>
                <input type="number" id="loanTermDays" value="180" min="1" step="1" class="block w-full border border-gray-300 rounded px-3 py-2 mb-2">
                <label class="block text-gray-700 mb-1">Min Cash Reserve Ratio (%)</label>
                <input type="number" id="minCashReserveRatio" value="20" min="0" max="100" step="0.01" class="block w-full border border-gray-300 rounded px-3 py-2">
            </div>
        </div>
        <!-- Main Content Section -->
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-2xl">
            <h1 class="text-2xl font-semibold text-blue-700 mb-6">Upload or Enter Revenue Data</h1>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1">Revenue Input Method</label>
                <select id="inputMethod" class="block w-full border border-gray-300 rounded px-3 py-2 mb-2">
                    <option value="upload">Upload CSV</option>
                    <option value="manual">Manual Entry</option>
                </select>
            </div>
            <div id="csvRevenueSection">
                <label class="block text-gray-700 mb-1">Revenue CSV</label>
                <input type="file" id="csvFile" accept=".csv" class="block bg-blue-400 text-white border border-blue-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4">
            </div>
            <div id="manualEntrySection" style="display:none;">
                <table class="w-full text-sm mb-2" id="manualRevenueTable">
                    <thead>
                        <tr>
                            <th class="px-1 py-1">Date</th>
                            <th class="px-1 py-1">DayOfWeek</th>
                            <th class="px-1 py-1">Revenue</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="manualRevenueList"></tbody>
                </table>
                <button type="button" id="addRevenueRow" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mb-2">Add Row</button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-1">Past Data Input Method</label>
                <select id="pastInputMethod" class="block w-full border border-gray-300 rounded px-3 py-2 mb-2">
                    <option value="upload">Upload CSV</option>
                    <option value="manual">Manual Entry</option>
                </select>
            </div>
            <div id="pastCsvSection">
                <label class="block text-gray-700 mb-1">Past Data CSV</label>
                <input type="file" id="pastDataFile" accept=".csv" class="lock bg-blue-400 text-white border border-blue-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4">
            </div>
            <div id="pastManualSection" style="display:none;">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm mb-2 min-w-[700px]" id="manualPastTable">
                        <thead>
                            <tr>
                                <th class="px-1 py-1">Date</th>
                                <th class="px-1 py-1">Item ID</th>
                                <th class="px-1 py-1">Quantity Sold</th>
                                <th class="px-1 py-1">Cost Per Item</th>
                                <th class="px-1 py-1">Original Cost To Manufacture</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="manualPastList"></tbody>
                    </table>
                </div>
                <button type="button" id="addPastRow" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mb-2">Add Row</button>
            </div>
            <button id="uploadCsv" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-3 transition-colors">
                Submit Data
            </button>
            <button id="predictRevenue" disabled class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-3 transition-colors">
                Predict Revenue
            </button>
            <button id="getAdvice" disabled class="w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded mb-3 transition-colors">
                Get Financial Advice
            </button>
            <div id="revenueMessage" class="min-h-[24px] text-center text-gray-700 mb-4"></div>
            <div id="adviceMessage" class="min-h-[24px] text-center text-gray-700 mb-4"></div>
            <div id="adviceSummary" class="bg-gray-50 border border-gray-300 rounded p-4 text-sm text-left mb-4 whitespace-normal" style="display:none;"></div>
            <div id="adviceDownload" class="text-center mb-4" style="display:none;">
                <a id="adviceCsvLink" href="#" download="suggested_price_changes_relative.csv" class="text-blue-600 underline">Download Advice CSV</a>
            </div>
            <div class="flex flex-col space-y-2">
                <a href="home.html" class="text-blue-600 hover:underline text-center">Back to Home</a>
                <a href="index.html" class="text-blue-600 hover:underline text-center">Back to Login</a>
            </div>
        </div>
        <!-- Expenses Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 w-[28rem] ml-6">
            <h2 class="text-xl font-semibold text-blue-700 mb-4">Expenses</h2>
            <!-- Import Buttons -->
            <div class="flex flex-col space-y-2 mb-4">
                <button id="importFromEmployees" class="bg-blue-400 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-sm">
                    Import from Employees
                </button>
                <button id="importFromStoreExpenses" class="bg-green-400 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-sm">
                    Import from Store Expenses
                </button>
                <button id="importFromInventory" class="bg-yellow-400 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded text-sm">
                    Import from Inventory
                </button>
                <button id="scanReceiptBtn" class="bg-pink-400 hover:bg-pink-600 text-white font-bold py-1 px-2 rounded text-sm">
                    Scan Receipt (PDF)
                </button>
                <input type="file" id="receiptPdfInput" accept="application/pdf" style="display:none;">
            </div>
            <!-- Save/Load Buttons -->
            <div class="flex space-x-2 mb-4">
                <button id="saveExpenses" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-sm">
                    Save Expenses
                </button>
                <button id="loadExpenses" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-2 rounded text-sm">
                    Load Expenses
                </button>
            </div>
            <form id="expensesForm">
                <table class="w-full text-sm mb-2" id="expensesTable">
                    <thead>
                        <tr>
                            <th class="px-1 py-1">Name</th>
                            <th class="px-1 py-1">Cost</th>
                            <th class="px-1 py-1">Due Date</th>
                            <th class="px-1 py-1">Other Dates</th>
                            <th class="px-1 py-1">Urgency</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="expensesList"></tbody>
                </table>
                <button type="button" id="addExpense" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-2 transition-colors">Add Expense</button>
            </form>
        </div>
    </main>
    <footer class="p-4 text-center text-white text-sm mt-8">
        &copy; 2025 Small Business Financial Tools. All rights reserved.
    </footer>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Revenue input toggle
        const inputMethod = document.getElementById('inputMethod');
        const csvRevenueSection = document.getElementById('csvRevenueSection');
        const manualEntrySection = document.getElementById('manualEntrySection');
        inputMethod.addEventListener('change', function() {
            if (inputMethod.value === 'manual') {
                csvRevenueSection.style.display = 'none';
                manualEntrySection.style.display = 'block';
            } else {
                csvRevenueSection.style.display = 'block';
                manualEntrySection.style.display = 'none';
            }
        })});

        // Past data input toggle
        const pastInputMethod = document.getElementById('pastInputMethod');
        const pastCsvSection = document.getElementById('pastCsvSection');
        const pastManualSection = document.getElementById('pastManualSection');
        pastInputMethod.addEventListener('change', function() {
            if (pastInputMethod.value === 'manual') {
                pastCsvSection.style.display = 'none';
                pastManualSection.style.display = 'block';
            } else {
                pastCsvSection.style.display = 'block';
                pastManualSection.style.display = 'none';
            }
        });

        // Manual revenue table logic
        const manualRevenueList = document.getElementById('manualRevenueList');
        document.getElementById('addRevenueRow').addEventListener('click', function() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="date" class="revenue-date border border-gray-300 rounded px-1 py-1 w-28" required></td>
                <td>
                    <select class="revenue-dayofweek border border-gray-300 rounded px-1 py-1 w-24" required>
                        <option value="">Day</option>
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                        <option>Sunday</option>
                    </select>
                </td>
                <td><input type="number" class="revenue-value border border-gray-300 rounded px-1 py-1 w-20" required></td>
                <td><button type="button" class="remove-revenue-row bg-red-200 hover:bg-red-400 text-red-800 font-bold px-2 py-1 rounded">‚úï</button></td>
            `;
            // Auto-fill DayOfWeek when date is picked
            const dateInput = tr.querySelector('.revenue-date');
            const daySelect = tr.querySelector('.revenue-dayofweek');
            dateInput.addEventListener('change', function() {
                if (dateInput.value) {
                    const date = new Date(dateInput.value);
                    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
                    const dayName = days[date.getDay()];
                    for (let i = 0; i < daySelect.options.length; i++) {
                        if (daySelect.options[i].value === dayName) {
                            daySelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            });
            tr.querySelector('.remove-revenue-row').addEventListener('click', function() {
                tr.remove();
            });
            manualRevenueList.appendChild(tr);
        });

        // Manual past data table logic (custom columns, fixed widths)
        const manualPastList = document.getElementById('manualPastList');
        document.getElementById('addPastRow').addEventListener('click', function() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="date" class="past-date border border-gray-300 rounded px-1 py-1 w-28" required></td>
                <td><input type="text" class="past-itemid border border-gray-300 rounded px-1 py-1 w-20" required></td>
                <td><input type="number" class="past-quantity border border-gray-300 rounded px-1 py-1 w-16" required></td>
                <td><input type="number" step="0.01" class="past-costperitem border border-gray-300 rounded px-1 py-1 w-20" required></td>
                <td><input type="number" step="0.01" class="past-originalcost border border-gray-300 rounded px-1 py-1 w-24" required></td>
                <td><button type="button" class="remove-past-row bg-red-200 hover:bg-red-400 text-red-800 font-bold px-2 py-1 rounded">‚úï</button></td>
            `;
            tr.querySelector('.remove-past-row').addEventListener('click', function() {
                tr.remove();
            });
            manualPastList.appendChild(tr);
        });

        // --- Submit Data Button Logic ---
        const uploadCsvBtn = document.getElementById('uploadCsv');
        const predictRevenueBtn = document.getElementById('predictRevenue');
        uploadCsvBtn.disabled = false; // Enable by default

        uploadCsvBtn.addEventListener('click', async function() {
            const revenueInputMethod = document.getElementById('inputMethod').value;
            const pastInputMethod = document.getElementById('pastInputMethod').value;
            const revenueMessage = document.getElementById('revenueMessage');
            revenueMessage.textContent = '';
            let formData = new FormData();
            const userId = localStorage.getItem('user_id'); // Get user ID
            formData.append('user_id', userId); // Include user ID

            // Revenue data
            if (revenueInputMethod === 'upload') {
                const file = document.getElementById('csvFile').files[0];
                if (!file) {
                    revenueMessage.textContent = 'Please select a Revenue CSV file.';
                    return;
                }
                formData.append('revenue_csv', file);
            } else {
                // Manual revenue
                const rows = document.querySelectorAll('#manualRevenueList tr');
                if (rows.length === 0) {
                    revenueMessage.textContent = 'Please add at least one revenue row.';
                    return;
                }
                let valid = true;
                const revenueData = [];
                rows.forEach(tr => {
                    const date = tr.querySelector('.revenue-date').value;
                    const day = tr.querySelector('.revenue-dayofweek').value;
                    const value = tr.querySelector('.revenue-value').value;
                    if (!date || !day || !value) valid = false;
                    revenueData.push({ Date: date, DayOfWeek: day, Revenue: parseFloat(value) });
                });
                if (!valid) {
                    revenueMessage.textContent = 'Please fill all fields in manual revenue entry.';
                    return;
                }
                formData.append('revenue_json', JSON.stringify(revenueData));
            }

            // Past data
            if (pastInputMethod === 'upload') {
                const file = document.getElementById('pastDataFile').files[0];
                if (!file) {
                    revenueMessage.textContent = 'Please select Past Data CSV file.';
                    return;
                }
                formData.append('past_data_csv', file);
            } else {
                // Manual past data
                const rows = document.querySelectorAll('#manualPastList tr');
                if (rows.length === 0) {
                    revenueMessage.textContent = 'Please add at least one past data row.';
                    return;
                }
                let valid = true;
                const pastData = [];
                rows.forEach(tr => {
                    const date = tr.querySelector('.past-date').value;
                    const itemid = tr.querySelector('.past-itemid').value;
                    const quantity = tr.querySelector('.past-quantity').value;
                    const costperitem = tr.querySelector('.past-costperitem').value;
                    const originalcost = tr.querySelector('.past-originalcost').value;
                    if (!date || !itemid || !quantity || !costperitem || !originalcost) valid = false;
                    pastData.push({
                        Date: date,
                        ItemID: itemid,
                        QuantitySold: parseInt(quantity),
                        CostPerItem: parseFloat(costperitem),
                        OriginalCostToManufacture: parseFloat(originalcost)
                    });
                });
                if (!valid) {
                    revenueMessage.textContent = 'Please fill all fields in manual past entry.';
                    return;
                }
                formData.append('past_data_json', JSON.stringify(pastData));
            }

            uploadCsvBtn.disabled = true;
            revenueMessage.textContent = 'Uploading...';

            try {
                const resp = await fetch('/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (resp.ok) {
                    revenueMessage.textContent = 'Data uploaded successfully! Now you can predict revenue.';
                    predictRevenueBtn.disabled = false;
                } else {
                    revenueMessage.textContent = data.message || 'Upload failed.';
                    predictRevenueBtn.disabled = true;
                }
            } catch (err) {
                revenueMessage.textContent = 'Error uploading data.';
                predictRevenueBtn.disabled = true;
            }
            uploadCsvBtn.disabled = false;
        });

        // --- Predict Revenue Button Logic ---
        predictRevenueBtn.addEventListener('click', async function() {
            const revenueMessage = document.getElementById('revenueMessage');
            revenueMessage.textContent = 'Training model and predicting...';
            predictRevenueBtn.disabled = true;
            try {
                // Send user_id as FormData
                const userId = localStorage.getItem('user_id');
                let formData = new FormData();
                formData.append('user_id', userId);

                const resp = await fetch('/predict_revenue', {
                    method: 'POST',
                    body: formData
                });
                if (resp.ok) {
                    revenueMessage.textContent = 'Prediction complete! You can now get financial advice.';
                    document.getElementById('getAdvice').disabled = false;
                } else {
                    const data = await resp.json();
                    revenueMessage.textContent = data.message || 'Prediction failed.';
                }
            } catch (err) {
                revenueMessage.textContent = 'Error during prediction.';
            }
            predictRevenueBtn.disabled = false;
        });

        // --- Get Financial Advice Button Logic ---
        const getAdviceBtn = document.getElementById('getAdvice');
        getAdviceBtn.addEventListener('click', async function() {
            const adviceMessage = document.getElementById('adviceMessage');
            const adviceSummary = document.getElementById('adviceSummary');
            const adviceDownload = document.getElementById('adviceDownload');
            const adviceCsvLink = document.getElementById('adviceCsvLink');
            adviceMessage.textContent = '';
            adviceSummary.style.display = 'none';
            adviceDownload.style.display = 'none';

            // Collect parameters
            const params = {
                profit_margin: 100,
                money_starting: parseFloat(document.getElementById('moneyStarting').value),
                interest_rate: parseFloat(document.getElementById('interestRate').value) / 100,
                loan_term_days: parseInt(document.getElementById('loanTermDays').value),
                min_cash_reserve_ratio: parseFloat(document.getElementById('minCashReserveRatio').value) / 100,
                expenses: []
            };

            // Collect expenses from table
            const expenseRows = document.querySelectorAll('#expensesList tr');
            expenseRows.forEach(tr => {
                const name = tr.querySelector('.expense-name')?.value || '';
                const cost = parseFloat(tr.querySelector('.expense-cost')?.value || 0);
                const due_date = tr.querySelector('.expense-due')?.value || '';
                const other_dates = tr.querySelector('.expense-other')?.value || '';
                const urgency = parseInt(tr.querySelector('.expense-urgency')?.value || 0);
                let other_possible_dates = [];
                if (other_dates) {
                    other_possible_dates = other_dates.split(',').map(s => s.trim()).filter(Boolean);
                }
                if (name && cost && due_date) {
                    params.expenses.push({
                        name,
                        cost,
                        due_date,
                        other_possible_dates,
                        urgency
                    });
                }
            });

            getAdviceBtn.disabled = true;
            adviceMessage.textContent = 'Getting advice...';

            try {
                const resp = await fetch('/get_advice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const data = await resp.json();
                if (resp.ok) {
                    adviceMessage.textContent = 'Advice ready!';
                    adviceSummary.innerHTML = data.advice || '';
                    adviceSummary.style.display = '';
                    adviceDownload.style.display = '';
                    adviceCsvLink.href = data.csv_download_url || '/download_advice_csv';

                    // --- Auto-download suggestions CSV ---
                    const downloadCsv = (url, filename) => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    };
                    // Download suggestions CSV
                    downloadCsv(adviceCsvLink.href, 'suggested_price_changes_relative.csv');
                    // Download df_revised.csv
                    downloadCsv('/df_revised.csv', 'df_revised.csv');
                } else {
                    adviceMessage.textContent = data.message || 'Failed to get advice.';
                }
            } catch (err) {
                adviceMessage.textContent = 'Error getting advice.';
            }
            getAdviceBtn.disabled = false;
        });

        // Expense List Logic (table-based, cleaner)
        const expensesList = document.getElementById('expensesList');
        document.getElementById('addExpense').addEventListener('click', function() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" required></td>
                <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" required></td>
                <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" required></td>
                <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="0"></td>
                <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
            `;
            tr.querySelector('.remove-expense').addEventListener('click', function() {
                tr.remove();
            });
            expensesList.appendChild(tr);
        });

        // --- Save Expenses to Account ---
        document.getElementById('saveExpenses').addEventListener('click', async function() {
            const userId = localStorage.getItem('user_id');
            if (!userId) return alert('User ID missing.');
            const expenseRows = document.querySelectorAll('#expensesList tr');
            const expenses = [];
            expenseRows.forEach(tr => {
                const name = tr.querySelector('.expense-name')?.value || '';
                const cost = parseFloat(tr.querySelector('.expense-cost')?.value || 0);
                const due_date = tr.querySelector('.expense-due')?.value || '';
                const other_dates = tr.querySelector('.expense-other')?.value || '';
                const urgency = parseInt(tr.querySelector('.expense-urgency')?.value || 0);
                let other_possible_dates = [];
                if (other_dates) {
                    other_possible_dates = other_dates.split(',').map(s => s.trim()).filter(Boolean);
                }
                if (name && cost && due_date) {
                    expenses.push({
                        name,
                        cost,
                        due_date,
                        other_possible_dates,
                        urgency
                    });
                }
            });
            try {
                const resp = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, expenses })
                });
                const data = await resp.json();
                if (resp.ok) {
                    alert('Expenses saved!');
                } else {
                    alert(data.message || 'Failed to save expenses.');
                }
            } catch (e) {
                alert('Error saving expenses.');
            }
        });

        // --- Load Expenses from Account ---
        document.getElementById('loadExpenses').addEventListener('click', async function() {
            const userId = localStorage.getItem('user_id');
            if (!userId) return alert('User ID missing.');
            try {
                const resp = await fetch(`/api/expenses?user_id=${encodeURIComponent(userId)}`);
                const data = await resp.json();
                if (resp.ok && data.expenses && Array.isArray(data.expenses)) {
                    const expensesList = document.getElementById('expensesList');
                    expensesList.innerHTML = '';
                    data.expenses.forEach(expense => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="${expense.name || ''}" required></td>
                            <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${expense.cost || ''}" required></td>
                            <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${expense.due_date || ''}" required></td>
                            <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" value="${(expense.other_possible_dates||[]).join(',')}" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                            <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="${expense.urgency || 0}"></td>
                            <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                        `;
                        tr.querySelector('.remove-expense').addEventListener('click', function() { tr.remove(); });
                        expensesList.appendChild(tr);
                    });
                } else {
                    alert(data.message || 'No expenses found.');
                }
            } catch (e) {
                alert('Error loading expenses.');
            }
        });

        // --- Import from Employees ---
        document.getElementById('importFromEmployees').addEventListener('click', async function() {
            const expensesList = document.getElementById('expensesList');
            let user_id = localStorage.getItem('user_id');
            if (!user_id) return alert('User ID missing.');
            try {
                const res = await fetch(`/employees?user_id=${encodeURIComponent(user_id)}`);
                const employees = await res.json();
                if (!Array.isArray(employees) || employees.length === 0) {
                    alert('No employees found.');
                    return;
                }
                // For each employee, generate 12 future paydays and add as expense rows
                const today = new Date();
                employees.forEach(emp => {
                    let freq = (emp.pay_frequency || "semimonthly").toLowerCase();
                    let periods = 12;
                    let payDates = [];
                    let payPerPeriod = 0;
                    let d = new Date(today);
                    if (freq === "weekly") {
                        payPerPeriod = emp.pay / 52;
                        for (let i = 0; i < periods; i++) {
                            let payday = new Date(d.getTime() + i * 7 * 24 * 60 * 60 * 1000);
                            payDates.push(payday);
                        }
                    } else if (freq === "biweekly") {
                        payPerPeriod = emp.pay / 26;
                        for (let i = 0; i < periods; i++) {
                            let payday = new Date(d.getTime() + i * 14 * 24 * 60 * 60 * 1000);
                            payDates.push(payday);
                        }
                    } else if (freq === "monthly") {
                        payPerPeriod = emp.pay / 12;
                        for (let i = 0; i < periods; i++) {
                            let payday = new Date(d.getFullYear(), d.getMonth() + i, d.getDate());
                            payDates.push(payday);
                        }
                    } else { // semimonthly (default)
                        payPerPeriod = emp.pay / 24;
                        let count = 0;
                        let temp = new Date(d);
                        while (count < periods) {
                            let first = new Date(temp.getFullYear(), temp.getMonth(), 1);
                            let fifteenth = new Date(temp.getFullYear(), temp.getMonth(), 15);
                            if (first >= d && count < periods) { payDates.push(first); count++; }
                            if (fifteenth >= d && count < periods) { payDates.push(fifteenth); count++; }
                            temp.setMonth(temp.getMonth() + 1);
                        }
                        payDates = payDates.slice(0, periods);
                    }
                    payDates.forEach(payday => {
                        const paydayStr = payday.toISOString().slice(0,10);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="Pay: ${emp.name || ''}" required></td>
                            <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${payPerPeriod.toFixed(2)}" required></td>
                            <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${paydayStr}" required></td>
                            <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                            <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="1"></td>
                            <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                        `;
                        tr.querySelector('.remove-expense').addEventListener('click', function() { tr.remove(); });
                        expensesList.appendChild(tr);
                    });
                });
            } catch (e) {
                alert('Failed to import from employees.');
            }
        });

        // --- Import from Store Expenses ---
        document.getElementById('importFromStoreExpenses').addEventListener('click', async function() {
            const expensesList = document.getElementById('expensesList');
            // Example: fetch a static file or endpoint for store expenses
            try {
                const res = await fetch('/user_data/store_expenses.json');
                if (!res.ok) { alert('No store expenses found.'); return; }
                const storeExpenses = await res.json();
                storeExpenses.forEach(exp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="${exp.name || ''}" required></td>
                        <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${exp.cost || ''}" required></td>
                        <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${exp.due_date || ''}" required></td>
                        <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" value="${(exp.other_possible_dates||[]).join(',')}" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                        <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="${exp.urgency || 0}"></td>
                        <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                    `;
                    tr.querySelector('.remove-expense').addEventListener('click', function() { tr.remove(); });
                    expensesList.appendChild(tr);
                });
            } catch (e) {
                alert('Failed to import from store expenses.');
            }
        });

        // --- Import from Inventory ---
        document.getElementById('importFromInventory').addEventListener('click', async function() {
            const expensesList = document.getElementById('expensesList');
            // Try to get inventory restock actions from localStorage (set by inventory.html)
            let expenses = [];
            try {
                expenses = JSON.parse(localStorage.getItem('expenses_to_add') || '[]');
            } catch (e) { expenses = []; }
            if (!Array.isArray(expenses) || expenses.length === 0) {
                alert('No inventory expenses found. Use "Add as Expense" in Inventory page.');
                return;
            }
            expenses.forEach(expense => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="${expense.name || ''}" required></td>
                    <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${expense.cost || ''}" required></td>
                    <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${expense.due_date || ''}" required></td>
                    <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                    <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="0"></td>
                    <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                `;
                tr.querySelector('.remove-expense').addEventListener('click', function() { tr.remove(); });
                expensesList.appendChild(tr);
            });
            // Clear after import
            localStorage.removeItem('expenses_to_add');
        });

        // --- OCR Receipt Logic ---
        const scanReceiptBtn = document.getElementById('scanReceiptBtn');
        const receiptPdfInput = document.getElementById('receiptPdfInput');
        scanReceiptBtn.addEventListener('click', function() {
            receiptPdfInput.value = '';
            receiptPdfInput.click();
        });
        receiptPdfInput.addEventListener('change', async function() {
            const file = receiptPdfInput.files[0];
            if (!file) return;
            scanReceiptBtn.disabled = true;
            scanReceiptBtn.textContent = 'Scanning...';
            try {
                const formData = new FormData();
                formData.append('receipt_pdf', file);
                const userId = localStorage.getItem('user_id');
                if (userId) formData.append('user_id', userId);
                const resp = await fetch('/ocr_receipt', {
                    method: 'POST',
                    body: formData
                });
                if (!resp.ok) {
                    alert('Failed to scan receipt.');
                    scanReceiptBtn.disabled = false;
                    scanReceiptBtn.textContent = 'Scan Receipt (PDF)';
                    return;
                }
                const data = await resp.json();
                if (!data.expenses || !Array.isArray(data.expenses) || data.expenses.length === 0) {
                    alert('No expenses found in receipt.');
                } else {
                    const expensesList = document.getElementById('expensesList');
                    data.expenses.forEach(expense => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="${expense.name || ''}" required></td>
                            <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${expense.cost || ''}" required></td>
                            <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${expense.due_date || ''}" required></td>
                            <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" value="${(expense.other_possible_dates||[]).join(',')}" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                            <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="${expense.urgency || 0}"></td>
                            <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                        `;
                        tr.querySelector('.remove-expense').addEventListener('click', function() { tr.remove(); });
                        expensesList.appendChild(tr);
                    });
                    alert('Expenses added from receipt!');
                }
            } catch (e) {
                alert('Error scanning receipt.');
            }
            scanReceiptBtn.disabled = false;
            scanReceiptBtn.textContent = 'Scan Receipt (PDF)';
        });

        // Check for expense data in localStorage and add as expense row if present
        (function() {
            let expenses = [];
            try {
                expenses = JSON.parse(localStorage.getItem('expenses_to_add') || '[]');
            } catch (e) {
                expenses = [];
            }
            if (Array.isArray(expenses) && expenses.length > 0) {
                expenses.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="text" class="expense-name border border-gray-300 rounded px-1 py-1 w-24" value="${expense.name || ''}" required></td>
                        <td><input type="number" class="expense-cost border border-gray-300 rounded px-1 py-1 w-16" value="${expense.cost || ''}" required></td>
                        <td><input type="date" class="expense-due border border-gray-300 rounded px-1 py-1 w-28" value="${expense.due_date || ''}" required></td>
                        <td><input type="text" class="expense-other border border-gray-300 rounded px-1 py-1 w-32" placeholder="YYYY-MM-DD,YYYY-MM-DD"></td>
                        <td><input type="number" class="expense-urgency border border-gray-300 rounded px-1 py-1 w-12" min="0" max="5" value="0"></td>
                        <td><button type="button" class="remove-expense bg-red-500 hover:bg-red-700 text-white font-bold px-2 py-1 rounded">‚úï</button></td>
                    `;
                    tr.querySelector('.remove-expense').addEventListener('click', function() {
                        tr.remove();
                    });
                    expensesList.appendChild(tr);
                });
                // Clear the localStorage so it doesn't add again
                localStorage.removeItem('expenses_to_add');
            }
        })();

    </script>
</body>
</html>